<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>案件一覧（ログイン付き）</title>
    <link rel="stylesheet" href="./style.css">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script>
      // Firebase 設定
     const firebaseConfig = {
       apiKey: "AIzaSyBYtkWuK0sbCYyQcVhLeFWCPhU7GhMG8pg",
       authDomain: "exceldisplay-505fc.firebaseapp.com",
       projectId: "exceldisplay-505fc",
       storageBucket: "exceldisplay-505fc.firebasestorage.app",
       messagingSenderId: "491087347583",
       appId: "1:491087347583:web:64f812b63ad8b6ac0be44a",
       measurementId: "G-D5H647GG6L"
     };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      // ページ読み込み時
      window.onload = () => {
        const loggedInCompany = localStorage.getItem("company_id");
        if (!loggedInCompany) {
          // 未ログインならログインフォームを表示
          document.getElementById("loginArea").style.display = "block";
          document.getElementById("listArea").style.display = "none";
        } else {
          // ログイン済みなので案件一覧を表示
          document.getElementById("loginArea").style.display = "none";
          document.getElementById("listArea").style.display = "block";
          fetchThreads();
        }
      };

      // ログイン処理
      async function login() {
        const companyID = document.getElementById("companyID").value.trim();
        const password = document.getElementById("password").value.trim();
        if (!companyID || !password) {
          alert("販売店IDとパスワードを入力してください");
          return;
        }

        try {
          const doc = await db.collection("companies").doc(companyID).get();
          if (!doc.exists) {
            alert("販売店IDが存在しません");
            return;
          }
          const data = doc.data();
          // 本番では平文でなくハッシュ化を推奨
          if (data.password !== password) {
            alert("パスワードが間違っています");
            return;
          }

          // ログイン成功
          localStorage.setItem("company_id", companyID);
          // ログインフォームを隠して案件一覧を表示
          document.getElementById("loginArea").style.display = "none";
          document.getElementById("listArea").style.display = "block";
          fetchThreads();
        } catch (err) {
          console.error("ログインエラー:", err);
          alert("ログイン中にエラーが発生しました");
        }
      }

      // 案件一覧を取得
      async function fetchThreads() {
        console.log("Fetching all companies...");
        const container = document.getElementById("cardContainer");
        container.innerHTML = "";

        try {
          const companiesSnapshot = await db.collection("companies").get();
          console.log("Number of company docs:", companiesSnapshot.size);

          for (const companyDoc of companiesSnapshot.docs) {
            console.log("Found companyDoc ID:", companyDoc.id);

            const threadsSnapshot = await companyDoc.ref.collection("threads").get();
            console.log("threads count for", companyDoc.id, ":", threadsSnapshot.size);

            threadsSnapshot.forEach(doc => {
              const data = doc.data();
              console.log("doc ID:", doc.id, "data:", data);

              // カード生成
              const card = document.createElement("div");
              card.className = "card";
              card.innerHTML = `
                <p>販売店番号: ${companyDoc.id}</p>
                <p>依頼日: ${data.requestDate || "-"}</p>
                <h3>${data.groupName || "不明"}</h3>
                <!-- 会社A側の場合、リンク先に role=companyA を付与し、販売店リポジトリの thread.html へ遷移 -->
                <a href="https://pinball19.github.io/oata/thread.html?company=${companyDoc.id}&thread=${doc.id}&role=companyA">
                  詳細を見る
                </a>
              `;
              container.appendChild(card);
            });
          }
        } catch (error) {
          console.error("データ取得エラー:", error);
        }
      }

      // ログアウト
      function logout() {
        localStorage.removeItem("company_id");
        window.location.reload();
      }
    </script>
</head>
<body>
  <!-- ログインフォーム -->
  <div id="loginArea" style="display: none;">
    <h2>会社Aログイン</h2>
    <input type="text" id="companyID" placeholder="会社AのID（例: companyA）">
    <input type="password" id="password" placeholder="パスワード">
    <button onclick="login()">ログイン</button>
  </div>

  <!-- 案件一覧表示 -->
  <div id="listArea" style="display: none;">
    <button onclick="logout()">ログアウト</button>
    <h1>案件一覧</h1>
    <div id="cardContainer" class="card-container"></div>
  </div>
</body>
</html>
